<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­ç²æ‰“å¡æ—¥å¸¸</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 1. æ›´æ›ç‚ºç©©å®šç‰ˆ Babelï¼Œè§£æ±ºç™½å±å ±éŒ¯å•é¡Œ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- Google Fonts: Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Import Map: ä½¿ç”¨ esm.sh è¼‰å…¥æ¨¡çµ„ -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://esm.sh/firebase@10.13.1/app",
        "firebase/auth": "https://esm.sh/firebase@10.13.1/auth",
        "firebase/firestore": "https://esm.sh/firebase@10.13.1/firestore"
      }
    }
    </script>

    <style>
        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        @keyframes heart-bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        .animate-heart {
            animation: heart-bounce 0.3s ease-in-out;
        }
        /* éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºå€ (è‹¥é‚„æœ‰éŒ¯èª¤æœƒé¡¯ç¤ºç´…å­—) */
        #error-display {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            color: red;
            padding: 20px;
            z-index: 9999;
            overflow: auto;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <!-- éŒ¯èª¤é¡¯ç¤ºå€ -->
    <div id="error-display"></div>

    <!-- è¼‰å…¥ä¸­ç•«é¢ -->
    <div id="root">
        <div style="display:flex;justify-content:center;align-items:center;height:100vh;flex-direction:column;color:#666;">
            <div style="font-size:24px;margin-bottom:10px;">ğŸ»</div>
            <div>ç³»çµ±å•Ÿå‹•ä¸­...</div>
            <div style="font-size:12px;margin-top:10px;opacity:0.6;">æ­£åœ¨é€£ç·šåˆ°è³‡æ–™åº«</div>
        </div>
    </div>

    <!-- å…¨å±€éŒ¯èª¤æ•æ‰ -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const errorDisplay = document.getElementById('error-display');
            if (errorDisplay) {
                errorDisplay.style.display = 'block';
                errorDisplay.innerHTML = `
                    <h3>ç™¼ç”ŸéŒ¯èª¤</h3>
                    <p><strong>è¨Šæ¯:</strong> ${message}</p>
                    <p>è‹¥æ˜¯ Babel Errorï¼Œé€šå¸¸é‡æ–°æ•´ç†æˆ–æ¸…é™¤å¿«å–å¯è§£æ±ºã€‚</p>
                `;
            }
        };
    </script>

    <!-- 2. åŠ å…¥ data-presets="env,react" æ˜ç¢ºæŒ‡å®šç·¨è­¯æ¨¡å¼ -->
    <script type="text/babel" data-type="module" data-presets="env,react">
        import React, { useState, useRef, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        
        // --- Firebase Imports ---
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInAnonymously, 
            signOut 
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            deleteDoc, 
            updateDoc, 
            doc,       
            onSnapshot, 
            query, 
            orderBy 
        } from 'firebase/firestore';

        // --- Icons Components ---
        const IconBase = ({ size = 24, className = "", children, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
                {...props}
            >
                {children}
            </svg>
        );

        const Droplets = (props) => <IconBase {...props}><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></IconBase>;
        const Sparkles = (props) => <IconBase {...props}><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"/></IconBase>;
        const Smile = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></IconBase>;
        const Home = (props) => <IconBase {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>;
        const PlusCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const ImageIcon = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconBase>;
        const Send = (props) => <IconBase {...props}><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></IconBase>;
        const Clock = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const MapPin = (props) => <IconBase {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const Heart = (props) => <IconBase {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBrMI4-2lczCGEc9baxL4hIVstyBCLojWE",
          authDomain: "makinsatdaka.firebaseapp.com",
          projectId: "makinsatdaka",
          storageBucket: "makinsatdaka.firebasestorage.app",
          messagingSenderId: "828692776788",
          appId: "1:828692776788:web:8d28603d904973db32aac1",
          measurementId: "G-HDL0ZZ0E7P"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'makinsatdaka'; 

        // --- Helper: Image Compression ---
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                        resolve(dataUrl);
                    };
                };
            });
        };

        // --- Helper: Date Functions ---
        const getChineseWeekDay = (date) => {
            const days = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
            return days[date.getDay()];
        };

        const getFormattedDate = (date) => {
            return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
        };

        // --- Main App Component ---
        function App() {
          const [user, setUser] = useState(null);
          const [activeTab, setActiveTab] = useState('home');
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [currentType, setCurrentType] = useState(null);
          const [inputText, setInputText] = useState('');
          const [selectedImage, setSelectedImage] = useState(null);
          const [posts, setPosts] = useState([]);
          const [isLoading, setIsLoading] = useState(true);
          const [isSubmitting, setIsSubmitting] = useState(false);
          
          // ç¯©é¸èˆ‡è©³ç´°æª¢è¦–ç‹€æ…‹
          const [filterCategory, setFilterCategory] = useState('all');
          const [selectedPost, setSelectedPost] = useState(null);

          // çœŸå¯¦æ™‚é–“ç‹€æ…‹
          const [now, setNow] = useState(new Date());

          const fileInputRef = useRef(null);

          // æ›´æ–°æ™‚é–“ (æ¯ç§’)
          useEffect(() => {
            const timer = setInterval(() => {
                setNow(new Date());
            }, 1000);
            return () => clearInterval(timer);
          }, []);

          // è‡ªå‹•åŒ¿åç™»å…¥
          useEffect(() => {
            const initAuth = async () => {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Auto login failed", error);
                }
            };
            initAuth();

            const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
              setUser(currentUser);
              setIsLoading(false);
            });
            return () => unsubscribe();
          }, []);

          // Firebase Firestore è³‡æ–™ç›£è½
          useEffect(() => {
            const postsCollection = collection(db, 'artifacts', appId, 'public_posts');
            const q = query(postsCollection); 

            const unsubscribe = onSnapshot(q, (snapshot) => {
              const loadedPosts = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              
              // å®¢æˆ¶ç«¯æ’åº (æ–°åˆ°èˆŠ)
              loadedPosts.sort((a, b) => {
                 if (a.createdAt && b.createdAt) {
                   return b.createdAt - a.createdAt;
                 }
                 return 0;
              });

              setPosts(loadedPosts);
              setIsLoading(false);
            }, (error) => {
              console.error("è®€å–è³‡æ–™å¤±æ•—:", error);
              setIsLoading(false);
            });

            return () => unsubscribe();
          }, []);

          const handleImageChange = async (e) => {
            if (e.target.files && e.target.files[0]) {
              const file = e.target.files[0];
              try {
                  const compressedBase64 = await compressImage(file);
                  setSelectedImage(compressedBase64);
              } catch (err) {
                  alert("åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹é‡è©¦");
                  console.error(err);
              }
            }
          };

          const openCheckIn = (type) => {
            setCurrentType(type);
            setIsModalOpen(true);
            setInputText('');
            setSelectedImage(null);
            setIsSubmitting(false);
          };

          const handleDeletePost = async (postId) => {
             if (window.confirm("ç¢ºå®šè¦åˆªé™¤é€™å‰‡æ‰“å¡å—ï¼Ÿ")) {
                 try {
                     await deleteDoc(doc(db, 'artifacts', appId, 'public_posts', postId));
                     if (selectedPost && selectedPost.id === postId) {
                         setSelectedPost(null); 
                     }
                 } catch (error) {
                     console.error("åˆªé™¤å¤±æ•—", error);
                     alert("åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
                 }
             }
          };

          const handleToggleLike = async (post) => {
              if (!user) return;
              try {
                  const postRef = doc(db, 'artifacts', appId, 'public_posts', post.id);
                  const newLikedState = !post.liked;
                  await updateDoc(postRef, {
                      liked: newLikedState
                  });
                  
                  if (selectedPost && selectedPost.id === post.id) {
                      setSelectedPost({...selectedPost, liked: newLikedState});
                  }
              } catch (error) {
                  console.error("æŒ‰è®šæ›´æ–°å¤±æ•—", error);
              }
          };

          const handleSubmit = async () => {
            if (!inputText && !selectedImage) {
              alert("è«‹è¼¸å…¥æ–‡å­—æˆ–ä¸Šå‚³åœ–ç‰‡ï¼");
              return;
            }

            if (!user) {
              alert("æ­£åœ¨é€£ç·šä¸­ï¼Œè«‹ç¨å¾Œå†è©¦...");
              return;
            }

            if (isSubmitting) return;

            setIsSubmitting(true);

            try {
              const postsCollection = collection(db, 'artifacts', appId, 'public_posts');
              
              await addDoc(postsCollection, {
                type: currentType.id,
                title: currentType.label,
                text: inputText,
                image: selectedImage,
                date: getFormattedDate(now), 
                time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }), 
                color: currentType.color,
                liked: false, 
                createdAt: Date.now(),
                uid: user.uid,
                author: 'å­ç²'
              });

              setIsModalOpen(false);
              setFilterCategory(currentType.id);
            } catch (error) {
              console.error("å¯«å…¥éŒ¯èª¤: ", error);
              if (error.code === 'resource-exhausted') {
                 alert("ç™¼å¸ƒå¤±æ•—ï¼šå³ä¾¿å£“ç¸®å¾Œæª”æ¡ˆä»éå¤§ï¼Œè«‹é¸ä¸€å¼µç°¡å–®ä¸€é»çš„ç…§ç‰‡ã€‚");
              } else {
                 alert(`ç™¼å¸ƒå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚\néŒ¯èª¤è¨Šæ¯: ${error.message}`);
              }
            } finally {
              setIsSubmitting(false);
            }
          };

          const checkInTypes = [
            { id: 'water', label: 'å–æ°´ç´€éŒ„', icon: <Droplets size={24} />, color: 'bg-blue-500', bgColor: 'bg-blue-100', textColor: 'text-blue-600' },
            { id: 'lipbalm', label: 'æ“¦è­·å”‡è†', icon: <Sparkles size={24} />, color: 'bg-pink-500', bgColor: 'bg-pink-100', textColor: 'text-pink-600' },
            { id: 'gummy', label: 'åƒè»Ÿç³–', icon: <Smile size={24} />, color: 'bg-orange-500', bgColor: 'bg-orange-100', textColor: 'text-orange-600' },
          ];

          // æ¸²æŸ“è©³ç´°è²¼æ–‡å¡ç‰‡ (Modal å…§)
          const renderPostDetailModal = () => {
              if (!selectedPost) return null;
              
              return (
                <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200" onClick={() => setSelectedPost(null)}>
                    <div className="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl relative" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-gray-100 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <span className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-xs ${selectedPost.color}`}>
                                   {selectedPost.type === 'water' && <Droplets size={14}/>}
                                   {selectedPost.type === 'lipbalm' && <Sparkles size={14}/>}
                                   {selectedPost.type === 'gummy' && <Smile size={14}/>}
                                </span>
                                <div>
                                  <h3 className="font-bold text-gray-800 text-sm">{selectedPost.title}</h3>
                                  <div className="flex items-center text-gray-400 text-xs gap-1">
                                    <Clock size={10} /> {selectedPost.time}
                                  </div>
                                </div>
                            </div>
                            
                            {user && selectedPost.uid === user.uid && (
                                <button 
                                    onClick={() => handleDeletePost(selectedPost.id)}
                                    className="text-gray-300 hover:text-red-500 p-2"
                                >
                                    <Trash2 size={18} />
                                </button>
                            )}
                        </div>

                        {selectedPost.image && (
                            <img src={selectedPost.image} alt="Post" className="w-full h-auto max-h-[60vh] object-cover bg-gray-50" />
                        )}

                        <div className="p-4">
                            <p className="text-gray-700 text-sm whitespace-pre-wrap mb-4">{selectedPost.text}</p>
                            
                            <div className="flex justify-between items-center pt-2 border-t border-gray-50">
                               <button 
                                    onClick={() => handleToggleLike(selectedPost)}
                                    className={`flex items-center gap-1 text-sm transition-colors ${selectedPost.liked ? 'text-red-500' : 'text-gray-400 hover:text-red-400'}`}
                                 >
                                   <Heart 
                                     size={18} 
                                     className={`mr-1 ${selectedPost.liked ? 'fill-current animate-heart' : ''}`} 
                                   /> 
                                   {selectedPost.liked ? 'å·²è®š' : 'è®š'}
                               </button>
                               <div className="text-xs text-gray-400 flex items-center gap-1">
                                  <MapPin size={12} /> å°åŒ—å¸‚
                               </div>
                            </div>
                        </div>
                        
                        <button onClick={() => setSelectedPost(null)} className="absolute top-2 right-2 p-1 bg-black/20 rounded-full text-white hover:bg-black/40">
                            <X size={16} />
                        </button>
                    </div>
                </div>
              );
          };

          // æ¸²æŸ“ã€Œé¦–é ã€å…§å®¹
          const renderHome = () => {
            const filteredPosts = filterCategory === 'all' 
                ? posts 
                : posts.filter(p => p.type === filterCategory);

            return (
                <div className="space-y-6 animate-in fade-in duration-500 pb-20">
                   {/* Buttons Grid */}
                   <div className="space-y-3 px-4">
                      <h2 className="text-gray-700 font-bold text-lg flex items-center gap-2">
                        <span className="w-1 h-6 bg-green-500 rounded-full"></span>
                        ä»Šæ—¥ä»»å‹™
                      </h2>
                      <div className="grid grid-cols-3 gap-3">
                        {checkInTypes.map((item) => (
                          <button
                            key={item.id}
                            onClick={() => openCheckIn(item)}
                            className={`${item.color} text-white rounded-2xl h-24 flex flex-col items-center justify-center shadow-lg transform active:scale-95 transition-all duration-200`}
                          >
                            <div className="bg-white/20 p-2 rounded-full mb-1 backdrop-blur-sm">
                              {item.icon}
                            </div>
                            <span className="text-sm font-medium">{item.label}</span>
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Feed / History */}
                    <div className="space-y-4">
                      <div className="flex items-center justify-between px-4">
                          <h2 className="text-gray-700 font-bold text-lg flex items-center gap-2">
                            <span className="w-1 h-6 bg-orange-400 rounded-full"></span>
                            æ‰“å¡å‹•æ…‹
                          </h2>
                          <div className="flex text-xs bg-white rounded-lg p-1 shadow-sm border border-gray-100">
                              <button 
                                onClick={() => setFilterCategory('all')}
                                className={`px-3 py-1 rounded-md transition-colors ${filterCategory === 'all' ? 'bg-gray-800 text-white' : 'text-gray-500'}`}
                              >å…¨éƒ¨</button>
                              {checkInTypes.map(type => (
                                  <button
                                    key={type.id}
                                    onClick={() => setFilterCategory(type.id)}
                                    className={`px-3 py-1 rounded-md transition-colors ${filterCategory === type.id ? 'bg-green-100 text-green-700 font-bold' : 'text-gray-500'}`}
                                  >
                                    {type.label.substring(0, 2)}
                                  </button>
                              ))}
                          </div>
                      </div>
                      
                      {filteredPosts.length === 0 ? (
                        <div className="text-center text-gray-400 py-10 px-4">
                          {isLoading ? "è¼‰å…¥ä¸­..." : "ç›®å‰æ²’æœ‰ç´€éŒ„ï¼Œ\né»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ‰“å¡å§ï¼"}
                        </div>
                      ) : (
                        <div className="grid grid-cols-3 gap-0.5 border-t border-gray-200">
                            {filteredPosts.map((post) => (
                                <div 
                                    key={post.id} 
                                    onClick={() => setSelectedPost(post)}
                                    className="relative aspect-square cursor-pointer overflow-hidden bg-gray-100 group"
                                >
                                    {post.image ? (
                                        <img src={post.image} alt={post.title} className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110" />
                                    ) : (
                                        <div className={`w-full h-full flex items-center justify-center ${post.color} opacity-80 text-white`}>
                                            {post.type === 'water' && <Droplets size={32}/>}
                                            {post.type === 'lipbalm' && <Sparkles size={32}/>}
                                            {post.type === 'gummy' && <Smile size={32}/>}
                                        </div>
                                    )}
                                    
                                    {/* å³ä¸Šè§’åˆ†é¡æ¨™ç±¤ */}
                                    <div className={`absolute top-1 right-1 w-2 h-2 rounded-full ${post.type === 'water' ? 'bg-blue-500' : post.type === 'lipbalm' ? 'bg-pink-500' : 'bg-orange-500'} ring-1 ring-white`}></div>

                                    {/* åº•éƒ¨æ—¥æœŸé®ç½© */}
                                    <div className="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/70 to-transparent p-1 pt-4">
                                        <p className="text-white text-[10px] font-medium text-center">
                                            {post.date.substring(5).replace('.', '/')}
                                        </p>
                                    </div>
                                </div>
                            ))}
                        </div>
                      )}
                    </div>
                </div>
            );
          };

          // æ¸²æŸ“ã€Œæˆ‘çš„ã€å…§å®¹
          const renderMe = () => {
            const myPosts = posts.filter(p => user && p.uid === user.uid);
            return (
                <div className="space-y-6 animate-in fade-in duration-500 px-4">
                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 flex items-center gap-4">
                        <div className="w-20 h-20 bg-yellow-300 rounded-full flex items-center justify-center text-4xl border-4 border-white shadow-md">
                            ğŸ»
                        </div>
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">å­ç²</h2>
                            <span className="bg-green-100 text-green-600 text-xs px-2 py-1 rounded-full">å“¡å·¥</span>
                            <p className="text-gray-400 text-xs mt-1">åŠ å…¥æ™‚é–“ï¼š2023.04.06</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-3 gap-3 text-center">
                        <div className="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                            <div className="text-xl font-bold text-blue-500">{myPosts.filter(p => p.type === 'water').length}</div>
                            <div className="text-xs text-gray-400">å–æ°´</div>
                        </div>
                        <div className="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                            <div className="text-xl font-bold text-pink-500">{myPosts.filter(p => p.type === 'lipbalm').length}</div>
                            <div className="text-xs text-gray-400">è­·å”‡è†</div>
                        </div>
                        <div className="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                            <div className="text-xl font-bold text-orange-500">{myPosts.filter(p => p.type === 'gummy').length}</div>
                            <div className="text-xs text-gray-400">è»Ÿç³–</div>
                        </div>
                    </div>
                </div>
            );
          };

          // Main View
          return (
            <div className="min-h-screen bg-gray-50 flex flex-col font-sans max-w-md mx-auto shadow-2xl overflow-hidden relative">
              
              {/* Header */}
              <div className="bg-gradient-to-b from-green-400 to-green-600 pt-8 pb-4 px-6 rounded-b-[30px] shadow-md z-10 text-white relative">
                <div className="flex justify-between items-center mb-6">
                  <div className="flex items-center gap-3">
                     <div className="relative">
                        <div className="w-12 h-12 bg-yellow-300 rounded-full border-2 border-white flex items-center justify-center overflow-hidden">
                           <span className="text-2xl">ğŸ»</span> 
                        </div>
                        <div className="absolute -bottom-1 -right-1 bg-red-400 text-xs px-1 rounded-full border border-white">å­ç²</div>
                     </div>
                     <div className="flex flex-col">
                       <span className="font-bold text-lg">å­ç²æ‰“å¡æ—¥å¸¸</span>
                       <span className="text-xs opacity-90 text-green-100">ä»Šæ—¥ç›®æ¨™ï¼šå¤šå–æ°´ï¼</span>
                     </div>
                  </div>
                  <div className="flex flex-col items-end">
                     <div className="text-xl font-bold tracking-widest">{getFormattedDate(now)}</div>
                     <div className="text-sm opacity-80">{getChineseWeekDay(now)}</div>
                  </div>
                </div>

                {/* Calendar Strip */}
                <div className="flex justify-between gap-2 mt-4 overflow-x-auto pb-2 no-scrollbar">
                   {[-2, -1, 0, 1, 2].map((offset) => {
                     const d = new Date(now);
                     d.setDate(now.getDate() + offset);
                     const dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][d.getDay()];
                     const isToday = offset === 0;
                     
                     return (
                         <div key={offset} className={`flex flex-col items-center justify-center w-14 h-16 rounded-xl flex-shrink-0 ${isToday ? 'bg-white text-green-600 shadow-lg scale-105' : 'bg-white/20 text-white'}`}>
                           <span className="text-lg font-bold">{String(d.getDate()).padStart(2, '0')}</span>
                           <span className="text-xs">{dayName}</span>
                         </div>
                     );
                   })}
                </div>
              </div>

              {/* Main Content */}
              <div className="flex-1 overflow-y-auto pt-6 pb-24">
                  {activeTab === 'home' && renderHome()}
                  {activeTab === 'me' && renderMe()}
              </div>

              {/* Check-in Modal */}
              {isModalOpen && currentType && (
                <div className="absolute inset-0 z-50 flex items-end justify-center bg-black/50 backdrop-blur-sm animate-in fade-in duration-200">
                  <div className="bg-white w-full rounded-t-[30px] p-6 shadow-2xl transform transition-transform duration-300 flex flex-col max-h-[85vh]">
                    <div className="flex justify-between items-center mb-4">
                      <div className="flex items-center gap-2">
                        <div className={`p-2 rounded-full ${currentType.bgColor} ${currentType.textColor}`}>
                          {currentType.icon}
                        </div>
                        <h3 className="text-xl font-bold text-gray-800">{currentType.label}</h3>
                      </div>
                      <button onClick={() => setIsModalOpen(false)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200">
                        <X size={20} className="text-gray-500" />
                      </button>
                    </div>

                    <div className="flex-1 overflow-y-auto">
                        <textarea
                          className="w-full bg-gray-50 rounded-xl p-4 text-gray-700 focus:outline-none focus:ring-2 focus:ring-green-300 resize-none mb-4 min-h-[120px]"
                          rows="4"
                          placeholder={`åˆ†äº«ä¸€ä¸‹ä½ çš„${currentType.label}å§...`}
                          value={inputText}
                          onChange={(e) => setInputText(e.target.value)}
                        ></textarea>

                        {selectedImage && (
                          <div className="relative mb-4 w-24 h-24">
                            <img src={selectedImage} alt="Preview" className="w-full h-full object-cover rounded-lg border" />
                            <button 
                              onClick={() => setSelectedImage(null)}
                              className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md"
                            >
                              <X size={12} />
                            </button>
                          </div>
                        )}
                    </div>

                    <div className="flex items-center justify-between pt-4 mt-auto">
                      <div className="flex gap-2">
                        <button 
                          onClick={() => fileInputRef.current.click()}
                          className="p-3 rounded-full bg-green-50 text-green-600 hover:bg-green-100 transition"
                        >
                          <ImageIcon size={24} />
                        </button>
                        <input 
                          type="file" 
                          ref={fileInputRef} 
                          className="hidden" 
                          accept="image/*"
                          onChange={handleImageChange}
                        />
                      </div>
                      
                      <button 
                        type="button"
                        onClick={handleSubmit}
                        disabled={isSubmitting}
                        className={`px-8 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 transition transform active:scale-95 ${
                            isSubmitting 
                            ? 'bg-gray-400 text-white cursor-not-allowed' 
                            : 'bg-green-600 text-white shadow-green-200 hover:bg-green-700'
                        }`}
                      >
                        {isSubmitting ? 'ç™¼å¸ƒä¸­...' : (
                            <>ç™¼å¸ƒ <Send size={18} /></>
                        )}
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Detail Modal Overlay */}
              {renderPostDetailModal()}

              {/* Bottom Navigation */}
              <div className="absolute bottom-0 w-full bg-white border-t border-gray-100 px-8 py-2 flex justify-between items-end pb-6 z-40">
                <button 
                  onClick={() => setActiveTab('home')}
                  className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'home' ? 'text-green-600' : 'text-gray-400'}`}
                >
                  <Home size={28} strokeWidth={activeTab === 'home' ? 2.5 : 2} />
                  <span className="text-xs font-medium">é¦–é </span>
                </button>
                <div className="relative -top-5">
                  <button 
                    onClick={() => openCheckIn(checkInTypes[2])}
                    className="w-16 h-16 bg-gradient-to-tr from-green-500 to-emerald-400 rounded-full shadow-lg shadow-green-200 flex items-center justify-center text-white border-4 border-white transform active:scale-95 transition"
                  >
                     <PlusCircle size={32} />
                  </button>
                </div>
                <button 
                  onClick={() => setActiveTab('me')}
                  className={`flex flex-col items-center gap-1 w-16 ${activeTab === 'me' ? 'text-green-600' : 'text-gray-400'}`}
                >
                  <User size={28} strokeWidth={activeTab === 'me' ? 2.5 : 2} />
                  <span className="text-xs font-medium">æˆ‘çš„</span>
                </button>
              </div>

            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
